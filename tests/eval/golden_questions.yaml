# Golden Questions - Regression Test Suite
#
# These are known-good queries that should parse correctly.
# Use eval harness to track parsing accuracy over time:
#   python tests/eval/run_eval.py tests/eval/golden_questions.yaml
#
# Format:
#   - id: unique identifier
#     query: natural language query
#     expected_intent: COUNT | DESCRIBE | COMPARE_GROUPS | FIND_PREDICTORS | CORRELATIONS
#     expected_metric: column name or null
#     expected_group_by: column name or null
#     expected_filters: list of filter specs (optional)
#     notes: explanation (optional)

questions:
  # COUNT queries
  - id: count_all_basic
    query: "how many patients?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null
    notes: "Basic count - no grouping, no filters"

  - id: count_with_grouping
    query: "how many patients by status?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "status"
    notes: "Count with breakdown by categorical variable"

  - id: count_with_breakdown_keyword
    query: "how many patients broken down by treatment?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "treatment"
    notes: "Broken down variant of grouping"

  # DESCRIBE queries
  - id: describe_single_variable
    query: "what is the average age?"
    expected_intent: DESCRIBE
    expected_metric: "age"
    expected_group_by: null
    notes: "Simple descriptive stats for one variable"

  - id: describe_with_grouping
    query: "average age by gender"
    expected_intent: DESCRIBE
    expected_metric: "age"
    expected_group_by: "gender"
    notes: "Descriptive stats with grouping"

  - id: describe_distribution
    query: "describe cholesterol levels"
    expected_intent: DESCRIBE
    expected_metric: "cholesterol"
    expected_group_by: null
    notes: "Full distribution (mean, median, std)"

  # COMPARE_GROUPS queries
  - id: compare_two_groups
    query: "compare LDL between treatment and control"
    expected_intent: COMPARE_GROUPS
    expected_metric: "LDL"
    expected_group_by: "treatment"
    notes: "Statistical comparison between groups"

  - id: compare_by_status
    query: "compare age across different statuses"
    expected_intent: COMPARE_GROUPS
    expected_metric: "age"
    expected_group_by: "status"
    notes: "Multi-group comparison"

  # Queries with filters
  - id: count_with_categorical_filter
    query: "how many active patients?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null
    # NOTE: Filter extraction for "active" without explicit column name requires schema knowledge
    # This is a known limitation - parser would need to infer that "active" maps to "status" column
    notes: "Count query - filter extraction requires schema knowledge"

  - id: describe_with_numeric_filter
    query: "average cholesterol for patients over 50"
    expected_intent: DESCRIBE
    expected_metric: "cholesterol"
    expected_group_by: null
    expected_filters:
      - column: "age"
        operator: ">"
        value: 50
    notes: "Descriptive stats with numeric filter"

  - id: count_with_exclusion_filter
    query: "how many patients excluding those with missing data?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null
    # NOTE: Filter extraction requires knowing which column has "missing data" - needs schema knowledge
    notes: "Count query - filter extraction requires schema knowledge"

  # Edge cases
  - id: count_with_breakdown_and_filter
    query: "how many active patients by treatment group?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "treatment"
    # NOTE: Filter extraction for "active" requires schema knowledge
    notes: "COUNT with grouping - filter extraction requires schema knowledge"

  - id: describe_with_multiple_keywords
    query: "what is the mean and median age?"
    expected_intent: DESCRIBE
    expected_metric: "age"
    expected_group_by: null
    notes: "Multiple statistical keywords (both map to DESCRIBE)"

  - id: count_total_variant
    query: "total number of patients"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null
    notes: "Alternative phrasing for count"

  - id: describe_summary_stats
    query: "summarize BMI statistics"
    expected_intent: DESCRIBE
    expected_metric: "BMI"
    expected_group_by: null
    notes: "Summary/summarize keyword â†’ DESCRIBE"

  # Real production queries (from user logs)
  - id: statin_count_breakdown
    query: "what statins were those patients on, broken down by count of patients per statin?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"
    notes: "Real user query - count by statin type"

  - id: exclude_na_statin_count
    query: "remove the n/a (0) - what statins were patients on?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"
    expected_filters:
      - column: "statin"
        operator: "!="
        value: 0
    notes: "Real user query - exclude n/a values (regression test for filter extraction bug)"

  # Ambiguous queries (low confidence expected)
  - id: ambiguous_breakdown
    query: "show me the data"
    expected_intent: DESCRIBE
    expected_metric: null
    expected_group_by: null
    notes: "Vague query - should have low confidence"

  - id: ambiguous_comparison
    query: "compare the groups"
    expected_intent: COMPARE_GROUPS
    expected_metric: null
    expected_group_by: null
    notes: "Vague comparison - missing which variable to compare"

  # Conversational refinement queries (ADR009 Phase 6)
  # These test context-aware LLM refinement handling
  - id: refinement_remove_na_with_context
    query: "remove the n/a"
    conversation_history:
      - query: "count patients by statin"
        intent: "COUNT"
        group_by: "statin"
        metric: null
        filters_applied: []
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"  # Should inherit from previous
    expected_filters:
      - column: "statin"
        operator: "!="
        value: 0
    notes: "Conversational refinement - LLM should detect this refines previous COUNT query"

  - id: refinement_exclude_with_context
    query: "exclude missing values"
    conversation_history:
      - query: "describe cholesterol"
        intent: "DESCRIBE"
        group_by: null
        metric: "cholesterol"
        filters_applied: []
    expected_intent: DESCRIBE
    expected_metric: "cholesterol"  # Should inherit from previous
    expected_group_by: null
    expected_filters:
      - column: "cholesterol"
        operator: "!="
        value: 0
    notes: "Conversational refinement - add exclusion filter to previous DESCRIBE"

  - id: refinement_update_filter_with_context
    query: "actually over 65"
    conversation_history:
      - query: "patients over 50"
        intent: "COUNT"
        group_by: null
        metric: null
        filters_applied:
          - column: "age"
            operator: ">"
            value: 50
            exclude_nulls: true
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null
    expected_filters:
      - column: "age"
        operator: ">"
        value: 65  # Should update from 50 to 65
    notes: "Conversational refinement - LLM should update existing age filter"

  - id: refinement_only_active_with_context
    query: "only active patients"
    conversation_history:
      - query: "count patients by treatment"
        intent: "COUNT"
        group_by: "treatment"
        metric: null
        filters_applied: []
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "treatment"  # Should inherit grouping
    expected_filters:
      - column: "status"
        operator: "=="
        value: "active"
    notes: "Conversational refinement - add filter while preserving grouping"

  - id: refinement_without_context_low_confidence
    query: "remove the n/a"
    conversation_history: []  # NO context
    expected_intent: DESCRIBE  # Falls back to generic
    expected_metric: null
    expected_group_by: null
    notes: "Refinement WITHOUT context - should have low confidence (<0.75)"

  # Real production queries from user logs
  - id: prod_statin_count_simple
    query: "how many patients were on statins"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null
    notes: "Real production query - simple count with filter inference"

  - id: prod_most_prescribed_statin_with_filter
    query: "excluding those not on statins, which was the most prescribed statin?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"
    notes: "Real production query - count with exclusion filter and implicit ordering"

  - id: prod_statin_breakdown
    query: "what statins were those patients on, broken down by count of patients per statin?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"
    notes: "Real production query - count by statin type"

  - id: prod_most_prescribed_statin
    query: "which statin was most prescribed?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"
    notes: "Real production query - superlative query (most)"

  - id: prod_most_common_hiv_regimen
    query: "what was the most common HIV regiment?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null  # Column doesn't exist in test data - tests intent classification only
    notes: "Real production query - typo 'regiment' should map to 'regimen'. GroupBy null for test compatibility."

  - id: prod_average_bmi
    query: "average BMI of patients"
    expected_intent: DESCRIBE
    expected_metric: "BMI"
    expected_group_by: null
    notes: "Real production query - simple average"

  - id: prod_average_ldl
    query: "average ldl of all patients"
    expected_intent: DESCRIBE
    expected_metric: "LDL"
    expected_group_by: null
    notes: "Real production query - average with 'all patients' phrase"

  - id: prod_most_common_current_regimen
    query: "what was the most common Current Regimen"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null  # Column doesn't exist in test data - tests intent classification only
    notes: "Real production query - most common with capitalized column name. GroupBy null for test compatibility."

  - id: prod_statin_by_regimen
    query: "what statins were those patients on, broken down by count of patients by their Current Regimen"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: "statin"
    notes: "Real production query - statin count grouped by regimen (multi-grouping)"

  - id: prod_correlations_multi_variable
    query: "how does bmi, statin use relate to the regiment that the person is on and their cd4 counts?"
    expected_intent: CORRELATIONS
    expected_metric: null
    expected_group_by: null
    notes: "Real production query - multi-variable correlation analysis"

  # Complex multi-step queries
  - id: complex_predictive_modeling
    query: "what combination of age, baseline cd4 count, bmi, and statin use best predicts virologic failure within 12 months?"
    expected_intent: FIND_PREDICTORS
    expected_metric: "virologic_failure"
    expected_group_by: null
    notes: "Complex query - multiple predictors with temporal outcome"

  - id: complex_survival_stratified
    query: "time to first cardiovascular event or death, stratified by statin use and baseline ldl above 100"
    expected_intent: FIND_PREDICTORS
    expected_metric: null  # Column doesn't exist in test data
    expected_group_by: null  # Column doesn't exist in test data - tests intent classification only
    notes: "Complex query - survival analysis with stratification and filters. Metric/GroupBy null for test compatibility."

  - id: complex_compare_with_filters
    query: "compare average cd4 change from baseline to 6 months between hiv regimens, only for those on statins with bmi > 25"
    expected_intent: COMPARE_GROUPS
    expected_metric: "cd4_change"
    expected_group_by: "hiv_regimen"
    notes: "Complex query - comparison with multiple filters and temporal logic"

  - id: complex_correlation_interactions
    query: "how does statin adherence and ldl reduction vary by baseline ldl category and regimen type?"
    expected_intent: CORRELATIONS
    expected_metric: null
    expected_group_by: null
    notes: "Complex query - correlation with interaction effects"

  - id: complex_count_nested
    query: "among patients with virologic suppression within 6 months, how many had cardiovascular events by statin use and baseline ldl category?"
    expected_intent: COUNT
    expected_metric: null
    expected_group_by: null  # Column doesn't exist in test data - tests intent classification only
    notes: "Complex query - count with nested conditions and multiple breakdowns. GroupBy null for test compatibility."
