---
description: Project setup, development workflow, and Makefile usage. Always use Makefile commands for testing, linting, and formatting.
globs: ["**/*"]
alwaysApply: true
---

# Project Setup and Development Workflow

## Project Structure

This is a **Clinical Analytics Platform** built with:
- **Python 3.11+** (required)
- **uv** package manager (preferred over pip)
- **Polars** for data processing (pandas prohibited in new code)
- **Streamlit** for UI
- **Ibis** for SQL generation
- **DuckDB** for in-memory analytics

## Initial Setup

### 1. Install Dependencies

```bash
# Install all dependencies including dev tools (ruff, mypy, pytest)
make install-dev

# Or manually:
uv sync --extra dev --group dev
```

### 2. Verify Setup

```bash
# Check that tools are available
make lint          # Should run ruff
make format-check  # Should check formatting
make type-check    # Should run mypy
make test          # Should run pytest
```

## Makefile Commands (Always Use These)

### Development Workflow

**Before making changes:**
```bash
make lint          # Check for linting issues
make format-check  # Check formatting
make test-fast     # Run fast tests
```

**After making changes:**
```bash
make format        # Auto-format code
make lint-fix      # Auto-fix linting issues
make test          # Run all tests
make check         # Run all checks (lint, format, type, test)
```

**Before committing:**
```bash
make check         # Full check: lint, format-check, type-check, test
# OR for faster feedback:
make check-fast    # Fast checks: lint, format-check, fast tests only
```

### Testing

```bash
make test              # Run all tests
make test-unit         # Unit tests only
make test-integration  # Integration tests only
make test-fast         # Fast tests (skip slow ones)
make test-cov          # Tests with HTML coverage report
make test-cov-term     # Tests with terminal coverage

# Module-specific tests (for faster feedback when working on specific modules)
make test-analysis     # Run analysis module tests
make test-core         # Run core module tests
make test-datasets     # Run datasets module tests
make test-e2e          # Run end-to-end tests
make test-loader       # Run loader module tests
make test-ui           # Run UI module tests
```

### Code Quality

```bash
make lint          # Run ruff linter (check only)
make lint-fix      # Run ruff linter and auto-fix issues
make format        # Format code with ruff
make format-check  # Check formatting without changes
make type-check    # Run mypy type checker
make type-check-strict  # Run mypy in strict mode
```

### Combined Checks

```bash
make check         # Run all: lint, format-check, type-check, test
make check-fast    # Fast version: lint, format-check, fast tests
make ci            # CI checks (for GitHub Actions)
```

### Running the Application

```bash
make run           # Start Streamlit application
make validate      # Run platform validation script
```

### Cleanup

```bash
make clean         # Clean generated files and caches
make clean-all     # Clean everything including venv
```

## Mandatory Workflow Rules

### 1. Always Use Makefile Commands

**NEVER run tools directly:**
```bash
# WRONG: Don't do this
ruff check src/
pytest tests/
mypy src/

# CORRECT: Use Makefile
make lint
make test
make type-check
```

### 2. Before Committing Code

**Always run checks:**
```bash
# Minimum: format and lint-fix
make format
make lint-fix

# Recommended: full check
make check

# If check fails, fix issues before committing
```

### 3. Environment Verification

**If commands fail with "command not found":**
1. Check if venv exists: `test -d .venv`
2. Install dev dependencies: `make install-dev`
3. Verify tools: `uv run ruff --version`

### 4. Testing Workflow

**When writing tests:**
1. Write test first (TDD when possible)
2. Run: `make test-fast` for quick feedback (or use module-specific: `make test-core`, `make test-analysis`, etc.)
3. Run: `make test-cov` to check coverage
4. Ensure tests pass before committing

**Test structure:**
- Use AAA pattern (Arrange-Act-Assert)
- Descriptive test names: `test_unit_scenario_expectedBehavior`
- Use fixtures from `tests/conftest.py`
- Follow patterns in `.cursor/rules/101-testing-hygiene.mdc`

## Project-Specific Patterns

### Package Manager: uv

This project uses **uv** (not pip). Always use:
```bash
uv sync --extra dev --group dev  # Install dependencies
uv run <command>                 # Run commands in venv
```

### Virtual Environment

- Location: `.venv/` (in project root)
- Managed by: `uv`
- Activation: Not needed (uv run handles it)

### Code Style

- **Formatter**: ruff (not black)
- **Linter**: ruff (not flake8)
- **Type checker**: mypy
- **Line length**: 100 characters
- **Python version**: 3.11+

### Import Organization

Ruff handles import sorting. Run `make format` to auto-fix.

### Type Hints

- Use type hints for all function signatures
- Run `make type-check` to verify
- See `.cursor/rules/103-staff-engineer-standards.mdc` for details

## Common Issues and Solutions

### Issue: "ruff: command not found"
**Solution:** Run `make install-dev` to install dev dependencies

### Issue: "mypy: command not found"
**Solution:** Run `make install-dev` to install dev dependencies

### Issue: Tests fail with import errors
**Solution:** Ensure you're using `uv run pytest` (via `make test`)

### Issue: Formatting check fails
**Solution:** Run `make format` to auto-fix, then commit

### Issue: Linting finds many errors
**Solution:** Run `make lint-fix` to auto-fix most issues

## CI/CD Integration

The `make ci` command runs checks suitable for CI:
- Linting
- Format checking
- Type checking
- Tests with coverage

Use this in GitHub Actions or similar CI systems.

## Quick Reference

```bash
# Setup
make install-dev

# Daily workflow
make format          # Format code
make lint-fix        # Fix linting
make test-fast       # Quick test (or use module-specific: test-core, test-analysis, test-ui, etc.)
make check           # Full check before commit

# Troubleshooting
make clean           # Clean caches
make validate        # Validate platform
```

## Integration with Other Rules

- **Testing**: See `.cursor/rules/101-testing-hygiene.mdc`
- **Code Quality**: See `.cursor/rules/103-staff-engineer-standards.mdc`
- **Data Processing**: See `.cursor/rules/100-polars-first.mdc`
- **DRY Principles**: See `.cursor/rules/102-dry-principles.mdc`
