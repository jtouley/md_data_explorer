---
status: pending
priority: p1
issue_id: "005"
tags: [code-review, security, critical, path-traversal]
dependencies: []
estimated_effort: medium
created_date: 2025-12-24
---

# Path Traversal Vulnerability in File Loading

## Problem Statement

**Critical path traversal vulnerability** in file loading code allows attackers to read arbitrary files from the filesystem by manipulating file paths in YAML configuration. Combined with the SQL injection vulnerability (#001), this creates a complete system compromise vector.

**Why it matters:**
- **CVSS Score: 8.6 (High)**
- Arbitrary file system access
- Exposure of sensitive system files (/etc/passwd, secrets, keys)
- Combined with SQL injection = complete system compromise
- HIPAA violation if deployed with patient data

**Impact:** Complete filesystem read access, credential theft

## Findings

**Locations:**
- `src/clinical_analytics/core/semantic.py:70-78` - No path validation
- `src/clinical_analytics/datasets/sepsis/loader.py:15-30` - Direct path usage

**Vulnerable Code:**
```python
# semantic.py:70-78
source_path = Path(init_params['source_path'])
abs_path = str(source_path.resolve())  # NO VALIDATION
duckdb_con.execute(f"CREATE TABLE {table_name} AS SELECT * FROM read_csv_auto('{abs_path}')")
```

**Attack Vector:**
```yaml
# Malicious datasets.yaml
malicious_dataset:
  init_params:
    source_path: "../../../etc/passwd"
  # Or using symlinks
  source_path: "data/symlink_to_secrets"
```

**Evidence:**
- No validation that paths are within allowed directories
- `Path.resolve()` follows symlinks
- No checks for path traversal sequences (../)
- Works with both absolute and relative paths
- DuckDB will happily read any CSV-like file

**Example Attack:**
```bash
# Create malicious config
echo "malicious:
  init_params:
    source_path: /etc/passwd" >> data/configs/datasets.yaml

# Access via Streamlit UI - exposes system users
```

## Proposed Solutions

### Solution 1: Path Allowlist with Symlink Detection (Recommended)
**Pros:**
- Prevents all path traversal attacks
- Detects symlink attacks
- Simple validation logic
- Defense in depth

**Cons:**
- Requires defining allowed directories
- May need updates for new data sources

**Effort:** Medium (3 hours)
**Risk:** Low

**Implementation:**
```python
from pathlib import Path
import os

class PathValidator:
    """Validates file paths are within allowed directories."""

    ALLOWED_DATA_DIRS = [
        Path(__file__).parent.parent.parent.parent / "data",
        Path("/secure/data/clinical")  # Production data mount
    ]

    @classmethod
    def validate_path(cls, path: Path) -> Path:
        """
        Validate path is within allowed directories.

        Raises:
            SecurityError: If path is outside allowed directories
            SecurityError: If path uses symlinks
        """
        # Check for symlinks in path
        if path.is_symlink():
            raise SecurityError(f"Symlinks not allowed: {path}")

        # Resolve to absolute path
        try:
            resolved = path.resolve(strict=True)
        except FileNotFoundError:
            raise ValueError(f"File not found: {path}")

        # Check if resolved path is within any allowed directory
        for allowed_dir in cls.ALLOWED_DATA_DIRS:
            try:
                resolved.relative_to(allowed_dir.resolve())
                return resolved  # Valid path
            except ValueError:
                continue

        # Path is outside all allowed directories
        raise SecurityError(
            f"Path outside allowed directories: {path}\n"
            f"Allowed: {[str(d) for d in cls.ALLOWED_DATA_DIRS]}"
        )

# Usage in semantic.py
def _register_source(self):
    source_path = Path(init_params['source_path'])

    # VALIDATE before use
    validated_path = PathValidator.validate_path(source_path)

    # Safe to use
    self.raw = self.con.read_csv(str(validated_path))
```

### Solution 2: Chroot-like Data Directory
**Pros:**
- All paths relative to data root
- Cannot escape data directory
- Simple to reason about

**Cons:**
- Less flexible
- Requires restructuring data layout
- Absolute paths not supported

**Effort:** Medium (4 hours including data reorganization)
**Risk:** Medium (breaking change)

**Implementation:**
```python
class DataPathResolver:
    """Resolves all paths relative to data root."""

    DATA_ROOT = Path(__file__).parent.parent.parent.parent / "data"

    @classmethod
    def resolve(cls, relative_path: str) -> Path:
        """Resolve path relative to data root only."""
        # Remove any leading slashes or parent references
        cleaned = relative_path.lstrip('/').replace('..', '')
        full_path = (cls.DATA_ROOT / cleaned).resolve()

        # Ensure result is still under DATA_ROOT
        try:
            full_path.relative_to(cls.DATA_ROOT)
        except ValueError:
            raise SecurityError(f"Path escape attempt: {relative_path}")

        return full_path
```

### Solution 3: File Hash Verification
**Pros:**
- Detects file tampering
- Additional security layer
- Works with other solutions

**Cons:**
- Requires maintaining hash database
- Performance overhead
- Doesn't prevent traversal alone

**Effort:** Medium (5 hours)
**Risk:** Low

## Recommended Action

**Implement Solution 1 (Path Allowlist)** with these components:

1. **PathValidator class** with allowlist and symlink detection
2. **Apply validation in all file loading locations**:
   - semantic.py:_register_source()
   - sepsis/loader.py
   - Any dataset loader that reads files
3. **Log all validation failures** for security monitoring
4. **Document allowed directories** in configuration

## Technical Details

**Affected Files:**
- `src/clinical_analytics/core/semantic.py` (line 70-78)
- `src/clinical_analytics/datasets/sepsis/loader.py` (line 15-30)
- All dataset loaders that read files

**New Files:**
```
src/clinical_analytics/security/
├── __init__.py
├── path_validator.py  # PathValidator class
└── exceptions.py      # SecurityError exception
```

**Configuration Changes:**
```yaml
# Add security section to datasets.yaml
security:
  allowed_data_directories:
    - "data/"
    - "/mnt/secure/clinical_data/"
  allow_symlinks: false  # Explicitly disable
```

**Testing Requirements:**
```python
def test_path_traversal_blocked():
    """Test that path traversal is prevented."""
    with pytest.raises(SecurityError, match="outside allowed"):
        PathValidator.validate_path(Path("../../../etc/passwd"))

def test_symlink_attack_blocked():
    """Test that symlinks are rejected."""
    # Create symlink pointing to /etc/passwd
    symlink = Path("data/malicious_link")
    symlink.symlink_to("/etc/passwd")

    with pytest.raises(SecurityError, match="Symlinks not allowed"):
        PathValidator.validate_path(symlink)

    symlink.unlink()

def test_allowed_paths_work():
    """Test that legitimate paths are allowed."""
    valid_path = Path("data/covid_ms/raw/data.csv")
    result = PathValidator.validate_path(valid_path)
    assert result.is_absolute()
    assert "data/covid_ms/raw/data.csv" in str(result)
```

## Acceptance Criteria

- [ ] PathValidator class implemented with allowlist
- [ ] Symlink detection prevents symlink attacks
- [ ] All file loading locations use PathValidator
- [ ] SecurityError raised for invalid paths
- [ ] Error messages do NOT reveal system paths
- [ ] Validation failures logged to security audit log
- [ ] Tests verify path traversal blocked
- [ ] Tests verify symlink attacks blocked
- [ ] Tests verify legitimate paths work
- [ ] Documentation updated with allowed directories
- [ ] Configuration file specifies allowed directories

## Work Log

### 2025-12-24
- **Action:** Security review identified path traversal vulnerability
- **Learning:** File path validation must happen before any filesystem operations
- **Next:** Implement PathValidator and apply to all file loading locations

## Resources

- **Security Review Report:** Path traversal findings
- **OWASP Path Traversal:** https://owasp.org/www-community/attacks/Path_Traversal
- **Python Path Security:** https://docs.python.org/3/library/pathlib.html#pathlib.Path.resolve
- **Related Issue:** SQL injection vulnerability (todo #001)
- **Symlink Attacks:** https://capec.mitre.org/data/definitions/132.html
