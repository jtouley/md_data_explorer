---
status: pending
priority: p1
issue_id: "001"
tags: [code-review, security, critical, sql-injection]
dependencies: []
estimated_effort: medium
created_date: 2025-12-24
---

# SQL Injection Vulnerability in Semantic Layer

## Problem Statement

**Critical SQL injection vulnerability** in `src/clinical_analytics/core/semantic.py` line 78 where file paths are directly interpolated into SQL queries using f-strings. An attacker with write access to the YAML configuration file could inject malicious SQL commands, leading to complete database compromise.

**Why it matters:**
- **CVSS Score: 9.8 (Critical)**
- Complete database compromise possible
- Data deletion, unauthorized access, potential code execution
- HIPAA compliance violation if deployed with PHI data

**Impact:** Database security completely bypassed

## Findings

**Location:** `src/clinical_analytics/core/semantic.py:78`

**Vulnerable Code:**
```python
abs_path = str(source_path.resolve())
duckdb_con = self.con.con
duckdb_con.execute(f"CREATE TABLE {table_name} AS SELECT * FROM read_csv_auto('{abs_path}')")
```

**Attack Vector:**
```yaml
# Malicious datasets.yaml
covid_ms:
  init_params:
    source_path: "data/file.csv'); DROP TABLE patients; --"
```

**Evidence from Review:**
- Direct string interpolation in SQL
- No parameterization or sanitization
- Config file writable by application
- DuckDB supports full SQL including DDL/DML

## Proposed Solutions

### Solution 1: Use DuckDB's Native Read API (Recommended)
**Pros:**
- Eliminates SQL string construction entirely
- Type-safe API
- No injection risk
- Cleaner code

**Cons:**
- Requires refactoring table registration logic
- May need to verify API compatibility with current Ibis usage

**Effort:** Medium (4 hours)
**Risk:** Low

**Implementation:**
```python
def _register_source(self):
    source_path = Path(init_params['source_path'])

    # Validate path is within allowed directory
    if not self._is_safe_path(source_path):
        raise ValueError(f"Invalid data path: {source_path}")

    abs_path = str(source_path.resolve())
    table_name = f"{self.dataset_name}_raw"

    # Use native API instead of SQL string
    self.raw = self.con.read_csv(abs_path, table_name=table_name)
```

### Solution 2: Path Validation + Parameterized Queries
**Pros:**
- Defense in depth
- Validates paths before use
- Still uses SQL for flexibility

**Cons:**
- More complex validation logic
- Partial mitigation only

**Effort:** Medium (3 hours)
**Risk:** Medium (validation bypass possible)

**Implementation:**
```python
import os
from pathlib import Path

def _is_safe_path(self, path: Path) -> bool:
    """Validate path is within allowed directory."""
    DATA_DIR = Path(__file__).parent.parent.parent.parent / "data"
    resolved = path.resolve()
    allowed = DATA_DIR.resolve()

    try:
        resolved.relative_to(allowed)
        return True
    except ValueError:
        return False

def _register_source(self):
    source_path = Path(init_params['source_path'])

    if not self._is_safe_path(source_path):
        raise SecurityError(f"Path outside allowed directory: {source_path}")

    # Use DuckDB's read_csv instead of SQL
    self.raw = self.con.read_csv(str(source_path.resolve()))
```

### Solution 3: Allowlist Approach
**Pros:**
- Strictest security
- No injection possible
- Simple logic

**Cons:**
- Less flexible
- Requires updating allowlist for new datasets

**Effort:** Small (2 hours)
**Risk:** Very Low

## Recommended Action

**Implement Solution 1 (DuckDB Native API)** + path validation from Solution 2 for defense in depth.

**Rationale:**
- Completely eliminates SQL injection vector
- Aligns with Ibis best practices
- Maintains functionality while improving security
- Path validation adds additional security layer

## Technical Details

**Affected Files:**
- `src/clinical_analytics/core/semantic.py` (primary)
- Potentially `src/clinical_analytics/datasets/sepsis/definition.py` (similar pattern line 70)

**Related Components:**
- DuckDB connection management
- Source registration for all datasets
- Ibis table creation

**Database Changes:** None (in-memory DuckDB)

**Configuration Changes:** None required

## Acceptance Criteria

- [ ] Remove all f-string SQL construction with user-supplied paths
- [ ] Use DuckDB's `read_csv()` API or equivalent safe method
- [ ] Add path validation to ensure paths are within `data/` directory
- [ ] Add unit tests for path validation (test injection attempts)
- [ ] Add security test attempting SQL injection through config
- [ ] Verify no symlink attacks possible
- [ ] Update all datasets to use safe pattern
- [ ] Document secure file loading pattern in code comments

## Testing Plan

```python
def test_sql_injection_prevention():
    """Test that SQL injection is blocked."""
    malicious_config = {
        'init_params': {
            'source_path': "data/file.csv'); DROP TABLE patients; --"
        }
    }

    with pytest.raises(ValueError, match="Invalid data path"):
        semantic = SemanticLayer('test', config=malicious_config)

def test_path_traversal_blocked():
    """Test that path traversal is prevented."""
    malicious_config = {
        'init_params': {
            'source_path': "../../../etc/passwd"
        }
    }

    with pytest.raises(ValueError, match="outside allowed directory"):
        semantic = SemanticLayer('test', config=malicious_config)
```

## Work Log

### 2025-12-24
- **Action:** Code review identified SQL injection vulnerability
- **Learning:** Direct string interpolation in SQL is dangerous even with "trusted" config files
- **Next:** Implement DuckDB native API approach with path validation

## Resources

- **Code Review Report:** See comprehensive security assessment
- **DuckDB Documentation:** https://duckdb.org/docs/api/python/overview
- **OWASP SQL Injection:** https://owasp.org/www-community/attacks/SQL_Injection
- **Similar Issues:** Check sepsis/definition.py line 70 for same pattern
- **Related Security Finding:** Path traversal vulnerability (todo #006)
