# ADR012: Ask Questions SOLID Refactoring

## Status

Accepted

## Context

The `03_ðŸ’¬_Ask_Questions.py` file had grown to 2706 lines and violated several SOLID principles:

1. **Single Responsibility Principle (SRP)**: The `execute_analysis_with_idempotency()` function combined cache checking, execution, storage, and rendering - four distinct responsibilities.

2. **Open/Closed Principle (OCP)**: The `render_analysis_by_type()` function used an if/elif ladder that required modification every time a new analysis type was added.

3. **Testability**: 50+ direct `st.session_state[...]` accesses made unit testing impossible without running a full Streamlit context.

## Decision

Extract four SOLID seams from the monolithic page:

### 1. AnalysisResult (Domain Model)

**Location**: `src/clinical_analytics/core/analysis_result.py`

Frozen dataclass providing typed structure for all analysis results:
- `type`: Analysis type identifier
- `payload`: Raw analysis data
- `friendly_error_message`: Human-readable error for failures
- `llm_interpretation`: LLM-generated interpretation
- `run_key`: Cache key for deduplication

### 2. StateStore (Session State Abstraction)

**Location**: `src/clinical_analytics/core/state_store.py`

Protocol with `get/set/contains/delete` operations:
- `InMemoryStateStore`: Test implementation using plain dict
- Future: `StreamlitStateStore`: Production implementation using st.session_state

Enables unit testing without Streamlit context.

### 3. AnalysisExecutor (Orchestration)

**Location**: `src/clinical_analytics/core/analysis_executor.py`

Single orchestration point for the analysis pipeline:
- Cache check before execution
- Result caching after execution
- Error translation enrichment
- LLM interpretation enrichment
- Conversation history updates

Includes structured logging for observability.

### 4. RendererRegistry (Strategy Pattern)

**Location**: `src/clinical_analytics/ui/components/renderers.py`

Extensible registry replacing if/elif ladder:
- `@register("type")` decorator for registration
- `render_result(result)` for dispatch
- Concrete renderers: Descriptive, Comparison, Predictor, Survival, Relationship, Count

Adding new analysis types requires only adding a new renderer class with the decorator.

## Consequences

### Positive

1. **Testability**: All new components can be unit tested without Streamlit
2. **Extensibility**: New analysis types require only a new renderer class
3. **Maintainability**: Each module has a single, clear responsibility
4. **Observability**: Structured logging throughout execution pipeline

### Negative

1. **Migration complexity**: Existing code must be updated to use new abstractions
2. **Learning curve**: Developers must understand the new architecture

### Test Coverage

| Phase | Module | Tests |
|-------|--------|-------|
| Phase 1 | AnalysisResult | 3 |
| Phase 2 | StateStore | 5 |
| Phase 3 | AnalysisExecutor | 6 |
| Phase 4 | RendererRegistry | 8 |
| Phase 5 | Migration Integration | 8 |
| **Total** | | **30** |

## Migration Strategy

The refactoring follows a phased approach:

1. Create new abstractions with full test coverage
2. Wire up new components alongside existing code
3. Mark deprecated functions for removal
4. Delete deprecated code once migration is verified

This ensures existing functionality remains working throughout the migration.

## References

- SOLID Principles: https://en.wikipedia.org/wiki/SOLID
- Strategy Pattern: https://refactoring.guru/design-patterns/strategy
- Protocol (PEP 544): https://peps.python.org/pep-0544/
